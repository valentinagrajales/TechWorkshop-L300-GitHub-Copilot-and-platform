@model ZavaStorefront.Models.ChatViewModel
@{
    ViewData["Title"] = "Chat with AI Assistant";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots me-2"></i>AI Assistant
                    </h5>
                    <form asp-action="ClearHistory" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-light btn-sm" title="Clear chat history">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </form>
                </div>
                
                @if (!ViewBag.IsConfigured)
                {
                    <div class="alert alert-warning m-3" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Configuration Required:</strong> The Azure OpenAI service is not configured. 
                        Please set the <code>AzureOpenAI:Endpoint</code> and <code>AzureOpenAI:ApiKey</code> in your configuration.
                    </div>
                }
                
                <div class="card-body" style="height: 450px; overflow-y: auto;" id="chatMessages">
                    @if (Model.Messages.Count == 0)
                    {
                        <div class="text-center text-muted py-5" id="welcomeMessage">
                            <i class="bi bi-robot" style="font-size: 3rem;"></i>
                            <p class="mt-3">Welcome! I'm your AI assistant powered by GPT-4o.</p>
                            <p>How can I help you today?</p>
                        </div>
                    }
                    else
                    {
                        foreach (var message in Model.Messages)
                        {
                            if (message.Role == "user")
                            {
                                <div class="d-flex justify-content-end mb-3">
                                    <div class="bg-primary text-white rounded-3 p-3" style="max-width: 75%;">
                                        <div class="message-content">@message.Content</div>
                                        <small class="text-white-50 d-block mt-1">@message.Timestamp.ToLocalTime().ToString("HH:mm")</small>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex justify-content-start mb-3">
                                    <div class="bg-light rounded-3 p-3" style="max-width: 75%;">
                                        <div class="message-content">@message.Content</div>
                                        <small class="text-muted d-block mt-1">@message.Timestamp.ToLocalTime().ToString("HH:mm")</small>
                                    </div>
                                </div>
                            }
                        }
                    }
                </div>
                
                <div class="card-footer bg-white">
                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" 
                               id="userInput" 
                               class="form-control" 
                               placeholder="Type your message..." 
                               autocomplete="off"
                               maxlength="2000">
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="bi bi-send"></i>
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Powered by Azure OpenAI GPT-4o via Microsoft Foundry
                </small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const chatMessages = $('#chatMessages');
            const userInput = $('#userInput');
            const sendButton = $('#sendButton');
            const chatForm = $('#chatForm');
            const welcomeMessage = $('#welcomeMessage');
            
            // Scroll to bottom of chat
            function scrollToBottom() {
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }
            
            // Format timestamp
            function formatTime(date) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Add message to chat
            function addMessage(content, isUser, timestamp) {
                if (welcomeMessage.length) {
                    welcomeMessage.remove();
                }
                
                const time = timestamp ? new Date(timestamp) : new Date();
                const messageHtml = isUser
                    ? `<div class="d-flex justify-content-end mb-3">
                         <div class="bg-primary text-white rounded-3 p-3" style="max-width: 75%;">
                           <div class="message-content">${escapeHtml(content)}</div>
                           <small class="text-white-50 d-block mt-1">${formatTime(time)}</small>
                         </div>
                       </div>`
                    : `<div class="d-flex justify-content-start mb-3">
                         <div class="bg-light rounded-3 p-3" style="max-width: 75%;">
                           <div class="message-content">${escapeHtml(content)}</div>
                           <small class="text-muted d-block mt-1">${formatTime(time)}</small>
                         </div>
                       </div>`;
                
                chatMessages.append(messageHtml);
                scrollToBottom();
            }
            
            // Add typing indicator
            function addTypingIndicator() {
                const typingHtml = `<div class="d-flex justify-content-start mb-3" id="typingIndicator">
                                     <div class="bg-light rounded-3 p-3">
                                       <div class="typing-indicator">
                                         <span></span><span></span><span></span>
                                       </div>
                                     </div>
                                   </div>`;
                chatMessages.append(typingHtml);
                scrollToBottom();
            }
            
            // Remove typing indicator
            function removeTypingIndicator() {
                $('#typingIndicator').remove();
            }
            
            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Handle form submission
            chatForm.on('submit', async function(e) {
                e.preventDefault();
                
                const message = userInput.val().trim();
                if (!message) return;
                
                // Disable input while processing
                userInput.prop('disabled', true);
                sendButton.prop('disabled', true);
                
                // Add user message to chat
                addMessage(message, true);
                userInput.val('');
                
                // Show typing indicator
                addTypingIndicator();
                
                try {
                    const response = await fetch('/Chat/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    removeTypingIndicator();
                    
                    if (response.ok) {
                        const data = await response.json();
                        addMessage(data.assistantMessage.content, false, data.assistantMessage.timestamp);
                    } else {
                        addMessage('Sorry, there was an error processing your request. Please try again.', false);
                    }
                } catch (error) {
                    removeTypingIndicator();
                    addMessage('Sorry, there was an error connecting to the server. Please try again.', false);
                    console.error('Chat error:', error);
                }
                
                // Re-enable input
                userInput.prop('disabled', false);
                sendButton.prop('disabled', false);
                userInput.focus();
            });
            
            // Handle Enter key
            userInput.on('keypress', function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.submit();
                }
            });
            
            // Initial scroll to bottom
            scrollToBottom();
            
            // Focus input on page load
            userInput.focus();
        });
    </script>
    
    <style>
        .typing-indicator {
            display: flex;
            gap: 4px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: #6c757d;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0; }
        
        @@keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        #chatMessages::-webkit-scrollbar {
            width: 6px;
        }
        
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #chatMessages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
}
