# Azure Deployment Plan for ZavaStorefront Project

> **GitHub Issue #2**: Provision Azure Infrastructure for ZavaStorefront Web Application (Dev Environment)

## **Goal**
Deploy the ZavaStorefront web application to Azure using Bicep with Azure Developer CLI (AZD), with all resources in the **westus3** region. The infrastructure should support containerized deployment using Azure Container Registry with managed identity authentication (no passwords), Application Insights for monitoring, and Azure AI Foundry for GPT-4 and Phi model access.

---

## **Project Information**

| Attribute | Value |
|-----------|-------|
| **Project Name** | ZavaStorefront |
| **Technology Stack** | ASP.NET Core 6.0 MVC Application |
| **Application Type** | E-commerce storefront with cart management |
| **Region** | westus3 |
| **Environment** | dev |
| **Deployment Tool** | Azure Developer CLI (azd) |
| **IaC Language** | Bicep |

---

## **Azure Resources Architecture**

> **Install the [Mermaid Preview extension](https://marketplace.visualstudio.com/items?itemName=bierner.markdown-mermaid) in VS Code to view the architecture diagram.**

```mermaid
graph TD
    subgraph "Resource Group (rg-zava-dev)"
        subgraph "Compute"
            ASP[Azure App Service<br/>Linux - B1 SKU]
        end
        
        subgraph "Container Registry"
            ACR[Azure Container Registry<br/>Basic SKU]
        end
        
        subgraph "Monitoring"
            AI[Application Insights]
            LAW[Log Analytics Workspace]
        end
        
        subgraph "AI Services"
            AOI[Azure AI Foundry<br/>GPT-4 & Phi Models]
        end
        
        subgraph "Identity"
            UMI[User Managed Identity]
        end
    end
    
    ASP -->|"pulls images<br/>(AcrPull role)"| ACR
    ASP -->|"sends telemetry"| AI
    AI -->|"stores logs"| LAW
    ASP -->|"uses AI models"| AOI
    UMI -->|"assigned to"| ASP
    UMI -->|"AcrPull role"| ACR
    UMI -->|"Cognitive Services User"| AOI
```

### Data Flow
1. **Container Registry → App Service**: App Service pulls container images from ACR using managed identity with AcrPull role (no credentials needed).
2. **App Service → Application Insights**: Application sends telemetry data for monitoring and diagnostics.
3. **Application Insights → Log Analytics**: Logs are stored and analyzed in Log Analytics Workspace.
4. **App Service → Azure AI Foundry**: Application accesses GPT-4 and Phi models for AI capabilities.

---

## **Recommended Azure Resources**

### 1. Azure App Service (Linux)

| Property | Value |
|----------|-------|
| **Hosting Type** | Azure App Service (Linux) |
| **SKU** | B1 (Basic) - 1 core, 1.75 GB RAM |
| **Runtime** | .NET 6.0 |
| **Container Source** | Azure Container Registry |
| **Authentication** | System-Assigned Managed Identity |

**Environment Variables:**
- `APPLICATIONINSIGHTS_CONNECTION_STRING` - Application Insights connection
- `AZURE_OPENAI_ENDPOINT` - Azure AI Foundry endpoint
- `ASPNETCORE_ENVIRONMENT` - Set to "Development"

---

### 2. Azure Container Registry (ACR)

| Property | Value |
|----------|-------|
| **SKU** | Basic (cost-effective for dev) |
| **Admin User** | Disabled (using RBAC) |
| **Anonymous Pull** | Disabled |
| **Build Method** | ACR Tasks (no local Docker required) |

**Key Features:**
- **ACR Tasks**: Build and push images without local Docker installation
- **Managed Identity**: App Service uses AcrPull role to pull images
- **No Credentials**: Zero password/credential management

---

### 3. Azure AI Foundry (Microsoft Foundry)

| Property | Value |
|----------|-------|
| **Region** | westus3 |
| **Models** | GPT-4, Phi |
| **Authentication** | Managed Identity with Cognitive Services User role |

---

### 4. Application Insights

| Property | Value |
|----------|-------|
| **Workspace Mode** | Workspace-based |
| **Linked To** | Log Analytics Workspace |
| **Sampling** | Enabled (reduce costs) |

---

### 5. Log Analytics Workspace

| Property | Value |
|----------|-------|
| **SKU** | PerGB2018 |
| **Retention** | 30 days (dev environment) |

---

### 6. User-Assigned Managed Identity

| Property | Value |
|----------|-------|
| **Role Assignments** | AcrPull on ACR, Cognitive Services User on AI Foundry |

---

## **Security Configuration**

| Configuration | Implementation |
|---------------|----------------|
| **Managed Identity** | User-Assigned Managed Identity for cross-resource authentication |
| **ACR Access** | AcrPull role (7f951dda-4ed3-4680-a7ca-43fe172d538d) assigned to managed identity |
| **AI Foundry Access** | Cognitive Services User role assigned to managed identity |
| **No Credentials** | All service-to-service communication uses RBAC, no passwords |
| **HTTPS Only** | Enforce HTTPS on App Service |

---

## **Local Development Without Docker**

Since the requirement specifies **no local Docker installation**, use these Azure-native approaches:

### Option 1: ACR Tasks (Recommended)
```bash
# Build and push directly in Azure
az acr build --registry <acr-name> --image zava-storefront:{{.Run.ID}} --file src/Dockerfile src/
```

### Option 2: AZD with ACR Tasks
Azure Developer CLI integrates with ACR Tasks automatically when configured in `azure.yaml`.

---

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to execute this plan.**

### Step 1: Initialize AZD Project
1. Create `azure.yaml` configuration file
2. Configure service mappings for ZavaStorefront

### Step 2: Generate Infrastructure as Code
1. Create `infra/` folder structure
2. Generate Bicep modules:
   - `main.bicep` - Main orchestration
   - `main.parameters.json` - Parameters
   - `modules/appservice.bicep` - App Service configuration
   - `modules/acr.bicep` - Container Registry
   - `modules/monitoring.bicep` - Application Insights + Log Analytics
   - `modules/ai-foundry.bicep` - Azure AI Foundry
   - `modules/identity.bicep` - Managed Identity + Role Assignments

### Step 3: Create Dockerfile
1. Create `src/Dockerfile` for the .NET 6.0 application
2. Optimize for production builds

### Step 4: Pre-Deployment Validation
1. Run `get_errors` tool to check Bicep syntax
2. Fix any errors before deployment

### Step 5: Deploy Infrastructure
```bash
# Initialize environment
azd init

# Preview changes
azd provision --preview

# Deploy infrastructure and application
azd up
```

### Step 6: Verify Deployment
1. Check deployment outputs for resource URLs
2. Verify Application Insights is receiving telemetry
3. Test AI Foundry connectivity

### Step 7: Documentation
1. Update repository README with deployment instructions
2. Save deployment summary to `.azure/summary.copilotmd`

---

## **Cost Optimization (Dev Environment)**

| Resource | Optimization |
|----------|-------------|
| App Service | B1 SKU (minimal for dev) |
| ACR | Basic SKU |
| Log Analytics | 30-day retention |
| AI Foundry | Pay-per-use |

**Estimated Monthly Cost**: ~$50-75 USD for dev workloads

---

## **File Structure After Implementation**

```
├── .azure/
│   ├── plan.copilotmd          # This plan
│   ├── summary.copilotmd       # Deployment summary
│   └── config.json             # AZD environment config
├── azure.yaml                  # AZD configuration
├── infra/
│   ├── main.bicep              # Main Bicep template
│   ├── main.parameters.json    # Parameters
│   └── modules/
│       ├── appservice.bicep
│       ├── acr.bicep
│       ├── monitoring.bicep
│       ├── ai-foundry.bicep
│       └── identity.bicep
└── src/
    ├── Dockerfile              # Container definition
    └── ... (existing code)
```

---

## **Next Steps**

To execute this plan, ask Copilot to:
1. **"Create the azure.yaml and Bicep infrastructure files"**
2. **"Create a Dockerfile for the ZavaStorefront application"**
3. **"Run azd up to deploy the infrastructure"**

---

*Plan generated based on GitHub Issue #2 requirements*
